<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <title>Enhanced LRC Maker</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="screen.css">
</head>
<body>


<div id="controls">
    <div>
        <div class="container">
                <button class='btn faster'>Faster</button>
                <button class='btn slower'>Slower</button>
                Speed: <span class='speed'>1.0</span>
                Position: <span class='position'>-</span>


            <ul>
                <li><a href='#' class='import-lyrics'>Import</a></li>
                <li><a href='#'>Export</a></li>
                <li><a href='#'>Save</a></li>
                <li><a href='#' class='show-help'>Help</a></li>
            </ul>
        </div>
    </div>
</div>

<audio controls="controls">
  <source src="onething.m4a" type="audio/mpeg" />
</audio>


<div class="container">

    <div id="lyrics"></div>

    <div id="introduction">
        <h1>Maker of Enhanced LRCs</h1>
        <p>This tool will help you create
            <a href="http://en.wikipedia.org/wiki/LRC_(file_format)#Enhanced_format">Enhanced LRC files</a>
            (where every word can be assigned a timestamp).
        </p>
        <p>
            After loading both an audio file and the lyrics text, you use
            mouse or keyboard to connect the correct word with the current
            playing position.
        </p>
        <p>
            Start by dragging & dropping an audio and a text file from your
            computer into this window. You can also load lyrics using the
            <em>Import</em> feature.
        </p>
        <p>
            <a class="import-lyrics">
              Import lyrics
            </a>
            <a class="show-help">
              Show detailed Help
            </a>
          </p>
    </div>
</div>


<div id="help" class="modal">
    <div class="header">
        <button class="close" data-dismiss="modal">×</button>
        <h3>ELRC Maker Help</h3>
    </div>
    <div class="body">
        <p>
            The general principle is that you load a text file with the
            subtitles/lyrics, and you load an audio file. While playing the
            audio file with reduced speed, you assigned each word with the
            current playing position.
        </p>
        <p>
            This can be done using the mouse, by simply clicking the word, or
            by using the keyboard, which advances a <em>keyboard cursor</em>
            through the text.
        </p>
        <p>
            The current word based on the timestamps already set will be
            highlighted in green color. If a word does not have a timestamp
            assigned, it's position will be guessed based on the timestamps
            already set.
        </p>
        <h4>Getting started</h4>
        <p>
            Load an audio file dragging it from your local computer and
            dropping it inside the browser window. Load lyrics by dragging
            a text file by dragging and dropping a text file from your local
            computer. You can also load lyrics via the <em>Import</em> menu
            options.
        </p>
        <h4>Mouse mode</h4>
        <dl>
            <dt>Left click on a word</dt>
                <dd>Associate the word with the current timestamp
                    (only while playing). This also moves the keyboard cursor.
                </dd>
            <dt>Right click on a word</dt>
                <dd>Set the play position to shortly before the word. If the
                    word has no time attached, the position will be guessed.
                </dd>
        </dl>
        <h4>Keyboard mode</h4>
        <dl>
            <dt>Left Arrow / Right Arrow</dt>
                <dd>Move the keyboard cursor forward/backwards to the text.
                </dd>
            <dt>Space</dt>
                <dd>Associated the word the keyboard cursor is at with the
                    current play position. Move the keyboard cursor one word
                    forward.
                </dd>
        </dl>
        <h4>Global shortcuts</h4>
        <dl>
            <dt>Space</dt>
                <dd>Start to play.</dd>
            <dt>Ctrl+Space</dt>
                <dd>Stop to play.</dd>
            <dt>Ctrl+Left Arrow / Ctrl+Right Arrow</dt>
                <dd>Skip play position forward or backward.</dd>
            <dt>Up Arrow / Down Arrow</dt>
                <dd>Increase / decrease the play speed.</dd>
        </dl>
    </div>
    <div class="footer">
        <a href="#" class="button">Close</a>
    </div>
</div>

<div id="import" class="modal">
    <div class="header">
        <button class="close" data-dismiss="modal">×</button>
        <h3>Import</h3>
    </div>
    <div class="body">
        <p>
            Paste some text here. <br>
            <em><i class="icon-exclamation-sign"></i>This
            will overwrite your current lyrics, and remove all timestamps
            that have already been assigned!</em>
        </p>
        <textarea></textarea><br>
    </div>
    <div class="footer">
        <a href="#" class="button">Load</a>
    </div>
</div>


<script src="merged.js"></script>
<script>
    $(function() {
        // Currently loaded Audio/Lyrics
        var lyrics = new Lyrics();
        var audio = $('audio')[0];

        // The Lyrics object needs the duration, not available right away.
        audio.addEventListener('durationchange',
            function() { lyrics.duration = audio.duration; });

        // Enable speed controls
        function setPlaybackRate(rate) {
            var newRate = audio.playbackRate;
            if (rate.constructor == Number)
                newRate = rate;
            else
                newRate += parseFloat(rate);
            newRate = Math.min(Math.max(newRate, 0.5), 4.0);
            audio.playbackRate = newRate;
            $('#controls .speed').text(newRate.toFixed(3));

        }
        $('.faster').click(function() { setPlaybackRate('+0.1'); });
        $('.slower').click(function() { setPlaybackRate('-0.1'); });
        setPlaybackRate(1.0);

        function updatePosition() {
            $('.position').text(
                Lyrics.toTimer(audio.currentTime) + ' / ' +
                Lyrics.toTimer(audio.duration));
        }
        audio.addEventListener('timeupdate', updatePosition);
        updatePosition();

        // Enable export/import buttons
        $('.export').click(function() {
            $.colorbox({html: '<textarea id="export">'+lyrics.toELRC()+'</textarea>'});
        });
        $('.import-lyrics').click(function() { $('#import').modal(); });
        $('.show-help').click(function() { $('#help').modal(); });
        $('#help .button').click(function() { $('#help').modal('hide'); });
        $('.save').click(function() {
            localStorage['lyrics'] = JSON.stringify(lyrics);
        });

        // The Lyrics controller
        var lyricsBox = new LyricsBox('#lyrics', audio);

        // The load-text dialog.
        $('#import .button').on('click', function() {
            var text = $('#import textarea').val();

            // Support a special JSON format that only I am using.s
            try {
                var json = jQuery.parseJSON(text);
                if (json.text)
                    text = cleanText(json.text);
            }
            catch (e) {}

            lyrics = Lyrics.fromText(text, audio.duration);
            lyricsBox.setLyrics(lyrics);

            // Store in local storage, so it won't be lost in reload
            localStorage['lyrics'] = JSON.stringify(lyrics);

            // Hide introduction, show, show lyrics
            $('#introduction').slideUp();
            $('#lyrics').slideDown();

            // Close dialog
            $('#import').modal('hide');
        });

        // Load lyrics from localStorage if there is anything
        if (localStorage['lyrics']) {
            lyrics = Lyrics.fromJSON(localStorage['lyrics'], audio.duration);
            lyricsBox.setLyrics(lyrics);
            $('#introduction').hide();
            $('#lyrics').show();
        }

        // Enable drag&drop of audio files
        $('body').on('dragenter dragover', function(e) {
            e.stopPropagation();
            e.preventDefault();
        });
        $('body').on('drop', function (event) {
            var data = event.originalEvent.dataTransfer;
            // originalEvent required, dataTransfer not in jQuery.event.props
            for (var i = 0; i < data.files.length; i++) {
                var fileReader = new FileReader();
                fileReader.onload = function(e) {
                    audio.src = e.target.result;
                };
                fileReader.readAsArrayBuffer(data.files[i]);

                // Only one file supported
                break;
            }
            return false;
        });

        // Keyboard shortcuts to skip forward/backward/change speed.
        $(document).on('keydown', function(e) {
            if (e.keyCode == 38) { // up
                setPlaybackRate('+0.1');
                return false;
            }
            else if (e.keyCode == 40) {  // down
                setPlaybackRate('-0.1');
                return false;
            }
            else if (e.keyCode == 32) {  // space
                if (audio.paused) {
                    audio.play();
                    return false;
                }
                else if (e.ctrlKey) {
                    audio.pause();
                    return false;
                }
            }
            else if (e.keyCode == 37) {  // left
                if (e.ctrlKey) {
                    audio.currentTime -= 1;
                    return false;
                }
            }
            else if (e.keyCode == 39) {  // right
                if (e.ctrlKey) {
                    audio.currentTime += 1;
                    return false;
                }
            }
        });

        window.geLyrics = function() { return lyrics };
    });
</script>
</body>
</html>